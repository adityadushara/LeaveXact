"use client"

import { useState, useEffect } from "react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Textarea } from "@/components/ui/textarea"
import { leaveAPI } from "@/lib/api"
import { useToast } from "@/components/ui/use-toast"
import { Users, Clock, CheckCircle, XCircle, Calendar, TrendingUp, FileText, AlertCircle, Eye, Check, X, User } from "lucide-react"
import Link from "next/link"
import { format } from "date-fns"

interface DashboardStats {
  totalEmployees: number
  pendingRequests: number
  approvedRequests: number
  rejectedRequests: number
}

export default function AdminDashboard() {
  interface DashboardStats {
    totalEmployees: number
    pendingRequests: number
    approvedRequests: number
    rejectedRequests: number
    currentlyOnLeave: number
    upcomingLeaves: number
  }

  const [stats, setStats] = useState<DashboardStats>({
    totalEmployees: 0,
    pendingRequests: 0,
    approvedRequests: 0,
    rejectedRequests: 0,
    currentlyOnLeave: 0,
    upcomingLeaves: 0
  })
  const [allRequests, setAllRequests] = useState<any[]>([])
  const [recentRequests, setRecentRequests] = useState<any[]>([])
  const [employees, setEmployees] = useState<any[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [selectedRequest, setSelectedRequest] = useState<any | null>(null)
  const [isRequestDialogOpen, setIsRequestDialogOpen] = useState(false)
  const [adminComments, setAdminComments] = useState("")
  const [isUpdating, setIsUpdating] = useState(false)
  const { toast } = useToast()

  useEffect(() => {
    fetchDashboardData()
  }, [])

  const fetchDashboardData = async () => {
    try {
      const [allRequests, users] = await Promise.all([
        leaveAPI.getAllRequests(),
        fetch("/api/users").then((r) => r.json()),
      ])
      // Filter out admin users - only count regular employees
      const totalEmployees = users.filter((user: any) => user.role !== 'admin').length
      const pendingRequests = allRequests.filter((r: any) => r.status === "pending").length
      const approvedRequests = allRequests.filter((r: any) => r.status === "approved").length
      const rejectedRequests = allRequests.filter((r: any) => r.status === "rejected").length
      
      // Calculate currently on leave and upcoming leaves
      const todayStr = getTodayString()
      console.log('Today:', todayStr); // Debug log
      
      const currentlyOnLeave = allRequests.filter((r: LeaveRequest) => {
        const isCurrentlyOnLeave = r.status === "approved" && r.startDate <= todayStr && todayStr <= r.endDate
        console.log('Checking leave request:', {
          id: r.id,
          userId: r.userId,
          startDate: r.startDate,
          endDate: r.endDate,
          status: r.status,
          isCurrentlyOnLeave
        });
        return isCurrentlyOnLeave;
      }).length
      
      // Calculate upcoming leaves for next 7 days
      const today = new Date()
      const nextWeek = new Date(today)
      nextWeek.setDate(today.getDate() + 7)
      const nextWeekStr = nextWeek.toISOString().split('T')[0]
      
      const upcomingLeaves = allRequests.filter((r: LeaveRequest) => {
        if (r.status !== "approved") return false
        return r.startDate > todayStr && r.startDate <= nextWeekStr
      }).length
      
      setStats({ totalEmployees, pendingRequests, approvedRequests, rejectedRequests, currentlyOnLeave, upcomingLeaves })
      setAllRequests(allRequests)
      setRecentRequests(allRequests.slice(0, 5))
      setEmployees(users)
    } catch (error: any) {
      toast({
        title: "Error",
        description: "Failed to fetch dashboard data",
        variant: "destructive",
        onClose: () => {}
      })
    } finally {
      setIsLoading(false)
    }
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case "approved":
        return <CheckCircle className="h-4 w-4 text-green-600" />
      case "rejected":
        return <XCircle className="h-4 w-4 text-red-600" />
      default:
        return <Clock className="h-4 w-4 text-yellow-600" />
    }
  }

  const getStatusBadge = (status: string) => {
    switch (status) {
      case "approved":
        return <Badge className="bg-green-100 text-green-800 hover:bg-green-100">Approved</Badge>
      case "rejected":
        return <Badge variant="destructive">Rejected</Badge>
      default:
        return <Badge className="bg-yellow-100 text-yellow-800 hover:bg-yellow-100">Pending</Badge>
    }
  }

  const calculateDays = (startDate: string, endDate: string) => {
    const start = new Date(startDate)
    const end = new Date(endDate)
    const diffTime = Math.abs(end.getTime() - start.getTime())
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1
  }

  // Helper to get today's date in YYYY-MM-DD format
  const getTodayString = () => {
    const today = new Date()
    return today.toISOString().split('T')[0]
  }

  interface LeaveRequest {
    id: string
    userId: string
    leaveType: string
    startDate: string
    endDate: string
    reason: string
    status: string
    comment?: string
    appliedAt: string
  }

  interface Employee {
    id: string
    name: string
    email: string
    role: string
    department: string
    employeeId: string
    leaveBalance: {
      annual: number
      sick: number
      personal: number
    }
  }

  const getEmployeesOnLeave = () => {
    const today = new Date()
    const todayStr = getTodayString()
    console.log('Getting employees on leave for:', todayStr)
    
    const employeesOnLeave: Array<{
      employee: Employee
      request: LeaveRequest
      daysRemaining: number
    }> = []

    allRequests.forEach((request: LeaveRequest) => {
      const isOnLeave = request.status === "approved" && 
                       request.startDate <= todayStr && 
                       todayStr <= request.endDate
      
      console.log('Checking leave request:', {
        id: request.id,
        userId: request.userId,
        startDate: request.startDate,
        endDate: request.endDate,
        status: request.status,
        isOnLeave
      })

      if (isOnLeave) {
        const employee = employees.find(emp => emp.id === request.userId)
        if (employee) {
          const endDate = new Date(request.endDate)
          const daysRemaining = Math.ceil((endDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))
          console.log('Found employee on leave:', employee.name, 'Days remaining:', daysRemaining)
          employeesOnLeave.push({
            employee,
            request,
            daysRemaining: Math.max(0, daysRemaining)
          })
        }
      }
    })

    console.log('Total employees on leave:', employeesOnLeave.length)
    return employeesOnLeave
  }  const getUpcomingLeaves = () => {
    const today = new Date()
    const nextWeek = new Date(today)
    nextWeek.setDate(today.getDate() + 7)
    
    const upcomingLeaves: Array<{
      employee: Employee
      request: LeaveRequest
      daysUntilStart: number
    }> = []

    allRequests.forEach((request: LeaveRequest) => {
      if (request.status === "approved") {
        const startDate = new Date(request.startDate)
        
        // Check if the leave starts within the next 7 days and hasn't started yet
        if (startDate > today && startDate <= nextWeek) {
          const employee = employees.find(emp => emp.id === request.userId)
          if (employee) {
            const daysUntilStart = Math.ceil((startDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))
            upcomingLeaves.push({
              employee,
              request,
              daysUntilStart
            })
          }
        }
      }
    })

    return upcomingLeaves.sort((a, b) => a.daysUntilStart - b.daysUntilStart)
  }

  const handleRequestCardClick = (request: any) => {
    console.log('Request card clicked:', request)
    setSelectedRequest(request)
    setAdminComments(request.comment || "")
    setIsRequestDialogOpen(true)
  }

  const handleStatusUpdate = async (requestId: string, status: "approved" | "rejected") => {
    setIsUpdating(true)
    try {
      await leaveAPI.updateRequestStatus(requestId, status, adminComments)

      toast({
        title: "Request Updated",
        description: `Leave request has been ${status}`,
        onClose: () => {}
      })

      // Refresh data
      await fetchDashboardData()
      setIsRequestDialogOpen(false)
      setAdminComments("")
    } catch (error: any) {
      toast({
        title: "Update Failed",
        description: error.response?.data?.message || "Failed to update request",
        variant: "destructive",
        onClose: () => {}
      })
    } finally {
      setIsUpdating(false)
    }
  }

  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold mb-6">Admin Dashboard</h1>
      <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
        <Card>
          <CardHeader>
            <CardTitle>Total Employees</CardTitle>
            <CardDescription>Number of employees in the system</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2 text-2xl font-bold">
              <Users className="h-6 w-6 text-primary" />
              {stats.totalEmployees}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader>
            <CardTitle>Currently on Leave</CardTitle>
            <CardDescription>Employees absent today</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2 text-2xl font-bold">
              <User className="h-6 w-6 text-orange-600" />
              {stats.currentlyOnLeave}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader>
            <CardTitle>Upcoming Leaves</CardTitle>
            <CardDescription>Next 7 days</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2 text-2xl font-bold">
              <Calendar className="h-6 w-6 text-blue-600" />
              {stats.upcomingLeaves}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader>
            <CardTitle>Pending Requests</CardTitle>
            <CardDescription>Awaiting approval</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2 text-2xl font-bold">
              <Clock className="h-6 w-6 text-yellow-600" />
              {stats.pendingRequests}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader>
            <CardTitle>Approved Requests</CardTitle>
            <CardDescription>Total approved leaves</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2 text-2xl font-bold">
              <CheckCircle className="h-6 w-6 text-green-600" />
              {stats.approvedRequests}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader>
            <CardTitle>Rejected Requests</CardTitle>
            <CardDescription>Total rejected leaves</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2 text-2xl font-bold">
              <XCircle className="h-6 w-6 text-red-600" />
              {stats.rejectedRequests}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Upcoming Leaves */}
      <Card className="mb-8">
        <CardHeader>
          <CardTitle className="flex items-center">
            <Calendar className="mr-2 h-5 w-5 text-blue-600" />
            Upcoming Leaves ({getUpcomingLeaves().length})
          </CardTitle>
          <CardDescription>Employees starting their leave in the next 7 days</CardDescription>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="text-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
            </div>
          ) : getUpcomingLeaves().length === 0 ? (
            <div className="text-center py-8">
              <Calendar className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
              <h3 className="text-lg font-medium text-muted-foreground mb-2">No Upcoming Leaves</h3>
              <p className="text-sm text-muted-foreground">No employees are starting their leave in the next 7 days</p>
            </div>
          ) : (
            <div className="space-y-4">
              {getUpcomingLeaves().map(({ employee, request, daysUntilStart }) => (
                <div key={employee.id} className="flex items-center justify-between p-4 border rounded-lg hover:bg-muted/30 transition-colors">
                  <div className="flex items-center space-x-4">
                    <div className="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                      <span className="text-sm font-medium text-blue-600">
                        {employee.name.split(' ').map((n: string) => n[0]).join('').toUpperCase()}
                      </span>
                    </div>
                    <div>
                      <h3 className="font-semibold">{employee.name}</h3>
                      <p className="text-sm text-muted-foreground">{employee.department} • {employee.employeeId}</p>
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="flex items-center space-x-2 mb-1">
                      <Badge variant="outline" className="capitalize">{request.leaveType}</Badge>
                      <Badge variant="secondary">Starts in {daysUntilStart} day{daysUntilStart !== 1 ? 's' : ''}</Badge>
                    </div>
                    <p className="text-sm text-muted-foreground">
                      {format(new Date(request.startDate), "MMM dd")} - {format(new Date(request.endDate), "MMM dd, yyyy")}
                    </p>
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Employees Currently on Leave */}
      <Card className="mb-8">
        <CardHeader>
          <CardTitle className="flex items-center">
            <User className="mr-2 h-5 w-5 text-orange-600" />
            Employees Currently on Leave ({getEmployeesOnLeave().length})
          </CardTitle>
          <CardDescription>Employees who are absent today</CardDescription>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="text-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
            </div>
          ) : getEmployeesOnLeave().length === 0 ? (
            <div className="text-center py-8">
              <User className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
              <h3 className="text-lg font-medium text-muted-foreground mb-2">No Employees on Leave</h3>
              <p className="text-sm text-muted-foreground">All employees are present today</p>
            </div>
          ) : (
            <div className="space-y-4">
              {getEmployeesOnLeave().map(({ employee, request, daysRemaining }) => (
                <div 
                  key={employee.id} 
                  className="p-4 border rounded-lg hover:bg-muted/30 transition-colors cursor-pointer space-y-3"
                  onClick={() => handleRequestCardClick(request)}
                >
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-4">
                      <div className="h-12 w-12 rounded-full bg-orange-100 flex items-center justify-center">
                        <span className="text-sm font-medium text-orange-600">
                          {employee.name.split(' ').map((n: string) => n[0]).join('').toUpperCase()}
                        </span>
                      </div>
                      <div>
                        <h3 className="font-semibold text-lg">{employee.name}</h3>
                        <p className="text-sm text-muted-foreground">
                          {employee.department} • {employee.employeeId}
                        </p>
                      </div>
                    </div>
                    <div className="text-right">
                      <Badge 
                        variant="secondary" 
                        className={`${daysRemaining <= 1 ? 'bg-red-100 text-red-800' : daysRemaining <= 3 ? 'bg-yellow-100 text-yellow-800' : ''}`}
                      >
                        {daysRemaining} day{daysRemaining !== 1 ? 's' : ''} left
                      </Badge>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4 p-3 bg-muted/50 rounded-lg">
                    <div>
                      <p className="text-sm font-medium mb-2">Leave Details</p>
                      <div className="space-y-1">
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-muted-foreground">Type:</span>
                          <Badge variant="outline" className="capitalize">{request.leaveType}</Badge>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-muted-foreground">Duration:</span>
                          <span className="text-sm">{calculateDays(request.startDate, request.endDate)} days</span>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-muted-foreground">Period:</span>
                          <span className="text-sm">
                            {format(new Date(request.startDate), "MMM dd")} - {format(new Date(request.endDate), "MMM dd")}
                          </span>
                        </div>
                      </div>
                    </div>

                    <div>
                      <p className="text-sm font-medium mb-2">Leave Balance</p>
                      <div className="space-y-1">
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-muted-foreground">Annual:</span>
                          <Badge variant="outline" className="bg-blue-50">{employee.leaveBalance?.annual || 0} days</Badge>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-muted-foreground">Sick:</span>
                          <Badge variant="outline" className="bg-red-50">{employee.leaveBalance?.sick || 0} days</Badge>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-muted-foreground">Personal:</span>
                          <Badge variant="outline" className="bg-green-50">{employee.leaveBalance?.personal || 0} days</Badge>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {request.reason && (
                    <div className="mt-2">
                      <p className="text-sm font-medium mb-1">Reason:</p>
                      <p className="text-sm text-muted-foreground bg-muted px-3 py-2 rounded">{request.reason}</p>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      <h2 className="text-xl font-semibold mb-4">Recent Leave Requests</h2>
      <div className="space-y-4">
        {recentRequests.map((request) => (
          <Card 
            key={request.id} 
            className="cursor-pointer hover:shadow-lg hover:scale-[1.02] transition-all duration-300 group"
            onClick={() => handleRequestCardClick(request)}
          >
            <CardContent className="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div className="flex items-center gap-3">
                <div className="group-hover:scale-110 transition-transform duration-300">
                  {getStatusIcon(request.status)}
                </div>
                <div>
                  <div className="font-medium group-hover:text-primary transition-colors duration-300">{request.leaveType} Leave</div>
                  <div className="text-sm text-muted-foreground">{request.reason}</div>
                  <div className="text-xs text-muted-foreground">
                    {format(new Date(request.startDate), "MMM d, yyyy")} -{" "}
                    {format(new Date(request.endDate), "MMM d, yyyy")}
                    <span className="ml-2">({calculateDays(request.startDate, request.endDate)} days)</span>
                  </div>
                </div>
              </div>
              <div className="group-hover:scale-110 transition-transform duration-300">
                {getStatusBadge(request.status)}
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      {/* Request Details Dialog */}
      <Dialog open={isRequestDialogOpen} onOpenChange={(open) => {
        console.log('Request dialog state changing:', open)
        setIsRequestDialogOpen(open)
      }}>
        <DialogContent className="max-w-2xl animate-in fade-in duration-500">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-3">
              {selectedRequest && getStatusIcon(selectedRequest.status)}
              {selectedRequest && `${selectedRequest.leaveType} Leave Request`}
            </DialogTitle>
            <DialogDescription>
              Detailed information about this leave request
            </DialogDescription>
          </DialogHeader>
          
          {selectedRequest && (
            <div className="space-y-6">
              {/* Request Status */}
              <div className="flex items-center justify-between p-4 bg-muted rounded-lg">
                <div className="flex items-center gap-3">
                  {getStatusIcon(selectedRequest.status)}
                  <div>
                    <div className="font-semibold capitalize">{selectedRequest.leaveType} Leave</div>
                    <div className="text-sm text-muted-foreground">
                      {format(new Date(selectedRequest.startDate), "MMM dd, yyyy")} - {format(new Date(selectedRequest.endDate), "MMM dd, yyyy")}
                    </div>
                  </div>
                </div>
                <Badge
                  variant={
                    selectedRequest.status === "approved"
                      ? "default"
                      : selectedRequest.status === "rejected"
                      ? "destructive"
                      : "secondary"
                  }
                  className="px-3 py-1"
                >
                  {selectedRequest.status}
                </Badge>
              </div>

              {/* Request Details */}
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <h4 className="font-semibold">Request Information</h4>
                  <div className="space-y-1 text-sm">
                    <div><span className="text-muted-foreground">Request ID:</span> {selectedRequest.id}</div>
                    <div><span className="text-muted-foreground">Leave Type:</span> <span className="capitalize">{selectedRequest.leaveType}</span></div>
                    <div><span className="text-muted-foreground">Duration:</span> {calculateDays(selectedRequest.startDate, selectedRequest.endDate)} days</div>
                    <div><span className="text-muted-foreground">Applied:</span> {selectedRequest.appliedAt ? format(new Date(selectedRequest.appliedAt), "MMM dd, yyyy HH:mm") : "—"}</div>
                  </div>
                </div>
                <div className="space-y-2">
                  <h4 className="font-semibold">Dates</h4>
                  <div className="space-y-1 text-sm">
                    <div><span className="text-muted-foreground">Start Date:</span> {format(new Date(selectedRequest.startDate), "EEEE, MMM dd, yyyy")}</div>
                    <div><span className="text-muted-foreground">End Date:</span> {format(new Date(selectedRequest.endDate), "EEEE, MMM dd, yyyy")}</div>
                    <div><span className="text-muted-foreground">Total Days:</span> {calculateDays(selectedRequest.startDate, selectedRequest.endDate)} days</div>
                  </div>
                </div>
              </div>

              {/* Reason */}
              <div className="space-y-2">
                <h4 className="font-semibold">Reason for Leave</h4>
                <div className="p-3 bg-muted rounded-lg">
                  <p className="text-sm">{selectedRequest.reason}</p>
                </div>
              </div>

              {/* Admin Comments */}
              <div className="space-y-2">
                <h4 className="font-semibold">Admin Comments</h4>
                <Textarea
                  placeholder="Add your comments (optional)..."
                  value={adminComments}
                  onChange={(e) => setAdminComments(e.target.value)}
                  rows={3}
                  className="hover:scale-[1.01] transition-transform duration-300"
                />
              </div>

              {/* Action Buttons */}
              <div className="flex gap-3 pt-4">
                {selectedRequest.status === "pending" && (
                  <>
                    <Button 
                      variant="destructive" 
                      className="group hover:scale-105 transition-all duration-300 hover:shadow-md"
                      onClick={() => handleStatusUpdate(selectedRequest.id, "rejected")}
                      disabled={isUpdating}
                    >
                      <X className="mr-2 h-4 w-4 group-hover:scale-110 transition-transform duration-300" />
                      Reject Request
                    </Button>
                    <Button 
                      className="group hover:scale-105 transition-all duration-300 hover:shadow-lg"
                      onClick={() => handleStatusUpdate(selectedRequest.id, "approved")}
                      disabled={isUpdating}
                    >
                      <Check className="mr-2 h-4 w-4 group-hover:scale-110 transition-transform duration-300" />
                      Approve Request
                    </Button>
                  </>
                )}
                <Button 
                  variant="outline"
                  className="flex-1 group hover:scale-105 transition-all duration-300 hover:shadow-md"
                  onClick={() => setIsRequestDialogOpen(false)}
                >
                  Close
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  )
}
